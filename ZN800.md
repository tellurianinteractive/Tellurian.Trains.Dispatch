# ZNF / ZLV Train Dispatch System

## Overview

The ZN800 (Zugnummernmeldeanlage 800 / Train Number Reporting System 800) is a German microprocessor-based train number reporting and dispatch system. Originally a Siemens design used by Deutsche Bahn (DB) since the 1980s, it has been adapted for model railways, particularly within FREMO (Freundeskreis Europäischer Modellbahner / Federation of European Model Railways).

The system tracks train movements and displays train numbers on computer screens or integrated control panels, transmitting train numbers electronically between operating points rather than via telephone - essential when model trains run at 4-8x real-time speed.

The related term **ZLV** (Zuglenk-Verkabelung / train routing wiring) refers to the communication bus and protocol used to transmit train number information between system components in the prototype railway system.

## Purpose

The ZN800 system provides:
- **Train number tracking** - Displays which train is at which location
- **Automatic propagation** - When a signal turns red, the train number automatically propagates through the network
- **Route determination** - Uses turnout/switch feedback to determine the destination routing for each train
- **Centralized display** - Shows train numbers at control positions and on track diagrams

## System Architecture

### Core Concepts

- **Unterstation (US)** - A train reporting system computer that participates in the ZLV-Bus. Normally there is one understation per signal box/interlocking.
- **ZN Server** - Central component that manages train number data and distributes it to clients
- Each FREMO operating point is represented as an Unterstation within the ZN800 system

### Components

1. **ZN Server** - Central component that manages train number data and distributes it to clients
2. **Train Describer/Display Units** - Display units showing train numbers at specific locations
3. **Understations (US)** - Client stations representing interlockings or control points
4. **User Interface Modules (EKA/DET)** - Operator interface components
5. **Gateway** - Bridges different protocol versions and handles protocol deviations

### Modular Software Architecture

The ZN800 implementation consists of several modular components:
- **Server** (required) - Core message routing
- **Console interface** (required) - Command-line control
- **Track plan visualization** (optional) - Graphical display
- **DET/EKA connection** (optional) - Hardware interface

Configuration requires three definition files:
1. **zn_ini** - System settings configuration
2. **zn_us** - Unterstation definitions
3. **zn_bs** - Track schematic/layout data (optional)

### Software Implementations

Several software implementations integrate ZN800 functionality:
- **Standalone implementation** by Moritz Hebert (original server, initially Visual Basic, later C#)
- **Elekdra interlocking system** by Thomas Kurz (Java-based, interface-agnostic design with no built-in UI)
- **EStW program** by Bodo Mertins (expanded server with gateway support)

All systems use **LotusNet** (also written "LoTUSnet") as the internal communication technology for connecting to interlocking systems and enabling use of commercial element decoders and feedback modules.

## Communication Methods

The ZN800 system supports three primary communication approaches:

### 1. ZLV-Bus over TCP/IP (Primary Method)

The mainstream implementation uses TCP/IP to emulate the ZLV-Bus over Ethernet networks.

**Architecture:**
- TCP server accepts connections from multiple clients (understations)
- Messages received by the server are propagated to all connected clients except the sender
- Server can be discovered via UDP broadcast

**Server Types:**
- Original protocol server (Hebert's design)
- New protocol server (UDP-discoverable)
- Gateway server (bridges both protocols, tolerates deviations)

### 2. LocoNet Protocol

Enables train number display messages to be transmitted over the LocoNet bus (Digitrax standard), commonly used in model railway digital control systems.

### 3. ZLV-Bus over LocoNet and Block

An experimental alternative that emulates a ZLV bus across multiple station LocoNets and block connections, enabling train movement communication between neighboring stations without separate Ethernet wiring.

## ZLV over TCP Protocol Specification

### Message Format

Messages follow this general structure:
```
identifier : telegram_data <CR><LF>
```

### Message Types

| Identifier | Purpose |
|------------|---------|
| `ZLV` | Train number telegram (ZN800 specification) |
| `UHR` | Time synchronization message |
| `ID` | Client welcome/identification message |

### ZLV Telegram Structure

The TCP protocol simplifies the original ZN800 specification by:
- Removing Byte 3 (info telegram start character)
- Removing Byte 11 (info telegram end character)
- Removing Byte 12 (checksum)
- Using ASCII codes instead of BCD for train numbers

| Position | Field | Description |
|----------|-------|-------------|
| Bytes 1-2 | US Number | Understation identifier (2 digits) |
| Byte 3 | ZN Telegram Number | Sequence identifier (1 digit) |
| Bytes 4-9 | Train Number | 6 digits; leftmost is guide number (0-9) |
| Bytes 10-11 | US Number | Understation identifier (repeated) |
| Bytes 12-15 | Track Number | 4 digits, right-aligned with leading blanks |

**Example:**
```
ZLV:04023_471104_201<CR><LF>
```

This represents:
- Understation: 04
- Telegram number: 0
- Train number: 3_4711 (guide number 3, train 4711)
- Understation (repeated): 04
- Track: 201

**Note:** The understation number appears twice in the telegram - once at the start and once before the track number. Current implementations cannot distinguish between leading zeros and blanks in track numbers.

### Encoding Rules

- Train numbers may use leading zeros or blanks for padding
- Track numbers use right-alignment with blank padding (leading zeros not recommended)
- All characters transmitted as ASCII values

## LocoNet Train Number Display Protocol

The LocoNet implementation uses an 8-byte peer-to-peer message format.

### Message Structure (16 bytes total)

| Byte | Field | Description |
|------|-------|-------------|
| 0 | Opcode | 0xE5 (OPC_PEER_XFER) |
| 1 | Length | 0x10 (16 bytes) |
| 2 | Source | Set to 0 for "master" |
| 3-4 | Destination | Display ID address |
| 5-6 | PXCT1, PXCT2 | MSB extension registers (set to 0) |
| 7-12 | D1-D6 | Data payload (6 digits) |
| 13 | D7 | Display orientation control |
| 14 | D8 | Unused (set to 0) |
| 15 | Checksum | Message checksum |

### Digit Encoding

Each digit occupies one data byte:
- **Bits 0-3:** Display value (0-9, or special codes)
- **Bit 4:** Flash indicator (set if digit should flash)
- **Bits 5-7:** Unused (set to 0)

### Special Character Codes

| Value | Display | Purpose |
|-------|---------|---------|
| 0-9 | Digits | Standard numerals |
| 0xC | L | LZB (Linienzugbeeinflussung) indicator |
| 0xD | E | Error digit |
| 0xE | F | Error prefix or availability notice |
| 0xF | Space | Padding unused positions |

### Display Control

Byte 13 (D7) determines orientation: value of 0 shows normal display; non-zero activates upside-down mode.

## ZLV-Bus over LocoNet and Block Protocol Stack

The experimental LocoNet/Block implementation uses a layered protocol architecture:

| Layer | Purpose |
|-------|---------|
| ZLV-Bus | Top application layer - train number messages using DB prototype telegram payloads |
| Broadcast | Simulates broadcast messaging; handles duplicate suppression from looping topologies |
| Generic 8 | Transports 8-bit bytes over LocoNet's native 7-bit capability |
| SLIP | Packet framing for signaling packet boundaries (RFC 1055) |
| LocoNet | Digitrax physical layer (station-wide, termed "LoTUSnet") |
| Block Cable | German block logic interface (RS244-RS232 converter for PC COM port connection) |

**Physical Configurations:**
- Left station variant: ZN kernel connected via station-wide LocoNet
- Right station variant: ZN kernel with direct block interface

## Hardware Components

### Train Number Displays

Several display board designs are available:

**Treudelburg Board**
- Up to five independent subsystems
- HDSP-2112 dot matrix displays
- ATmega8 controller per subsystem
- 5V LotusNet communication

**7-Segment LED Display (Erbert Frame)**
- Two-board design with six 7-segment LED displays
- MAX7219 display driver chip
- Synchronous serial interface (SPI-like) at 5V

**Chinese 7-Segment Display Module**
- Commercial 8-digit module (maskable to 6)
- Dimensions: 82.5 x 15.3 x 17.9mm
- SPI-like interface at 5V

**SpDrS60 Prototype Display**
- Seven-segment display for Siemens SpDrS60 control table
- Single grid position footprint
- SPI interface connection

### EKA/DET User Interface

The EKA/DET is the primary operator control interface:

**EKA (Eingabekontrollanzeige / Input Control Display)**
- 32-character alphanumeric LED dot matrix display
- Shows train numbers, system status, and feedback

**DET (Dateneingabetastatur / Data Input Keypad)**
- 8 × 4 button matrix
- Numeric keys (0-9)
- Function keys: SPE (program), LOE (delete), ANZ (display)
- Specialized railroad controls: ZNL, UHR (clock)
- Often built from salvaged Siemens telephone keypads (pre-1990 models)

**Technical Architecture:**
- ATmega128 processor core
- Internal interfaces via five connectors:
  - Port B/SV13: Address lines (A0-A4) and flash control
  - Port A/SV14: Control signals (read/write, chip enable)
  - Port F/SV16: 8-bit data bus (D0-D7)
  - Port C/SV12: Four keypad rows
  - Port D/SV11: Eight keypad columns

**External Connections:**
- 9-pole Sub-D connector (RS232)
- LocoNet socket
- 2.5mm power connector

### Housing Construction

Standard construction uses:
- MDF board cases with gray finish (matches FREMO module aesthetics)
- 1.5mm polystyrene panels with silk-matte black lacquer
- 2mm reinforcement frames
- Modular design allowing integrated or standalone configurations

## Time Synchronization

The system includes specialized time synchronization:
- Gateway software receives time from MRclock servers via multicast
- Time is forwarded to ZN clients via `UHR` messages
- Only hours and minutes are transmitted (seconds always "00") to prevent abrupt clock jumps

## Integration with Interlocking Systems

### EStW2006 Integration

The EStW2006 (Elektronisches Stellwerk / Electronic Interlocking) by Bodo Mertins integrates with ZN800:

**Architecture:**
- Separate components for logic and user interface
- Network-connected modules allowing unlimited operating units per logic module
- SpDr60-style technical implementation

**Features:**
- Route types: bypass, train, and shunting routes
- Variable speed slip routes
- Long and short entry/exit routes
- Element-by-element route release as trains pass
- Block methods: relay block, automatic block, central block
- Train number forwarding similar to real operations

**Model Railway Features:**
- LocoNet connectivity (preferred for new installations)
- Animated platform clocks showing model time
- Realistic lighting effects (flickering neon, mercury lamp warm-up)
- Nighttime signal dimming with twilight sensor
- Axle counters for track occupancy detection

## Understation Numbering

FREMO maintains a registry of understation numbers (currently 76+ assigned, 01-96+):

- Each station receives a unique 2-digit identifier
- Associated with a three-letter shortname and railway facility name
- One understation per signal box is the norm

**Examples:**
- 01: Michelstadt
- 70: Marienborn
- 71: Zwickau

To obtain a number, register in the FREMO forum in the Signal category.

## Technical Background

The reference implementations use:
- **Delphi 5 Professional** with Francois Piette's ICS network components
- **PosPanel.pas** component for panel displays
- Standard TCP/IP networking for inter-station communication
- **C#** for newer implementations
- **Java** for Elekdra interlocking

## References

- [FREMO ZNF800 Documentation](https://fremo-stw.sourceforge.net/ZNF800/index.en.html)
- [ZLV over TCP Protocol Specification](https://fremo-stw.sourceforge.net/ZNF800/ZlvOverTcp.html)
- [Bodo Mertins ZN Implementation](https://www.bmertins.de/FREMO/ZN/index.html)
- [Michael Weinert ZN800 Introduction](http://www.mw-modellbau.de/05_ZN800/ZN800.htm)
- [LocoNet Train Number Display Protocol](https://fremo-stw.sourceforge.net/ZNF800/TrainNumberDisplayMessage.en.html)
- [ZLV over LocoNet and Block](https://fremo-stw.sourceforge.net/ZNF800/ZlvOverLnAndBlock.html)
- [Train Number Displays](https://fremo-stw.sourceforge.net/ZNF800/displays.en.html)
- [EKA/DET User Interface](https://fremo-stw.sourceforge.net/ZNF800/det_eka/index.en.html)

## Documentation Status Notes

This documentation is compiled from multiple FREMO community sources. As a hobby project, the original documentation has some inconsistencies:

- **Language synchronization**: The German main page links to English sub-pages for technical details, indicating incomplete German translations
- **Missing resources**: Some referenced pages (STN, FStw, block diagram PDF) return 404 errors
- **Multiple authors**: Different components documented by different contributors (Stefan Bormann, Moritz Hebert, Bodo Mertins, Michael Weinert)
- **Active development**: The Elekdra system is noted as "under development" with planned features

For the most current information, consult the FREMO-Signal mailing list or the FREMO forum's Signal category.
